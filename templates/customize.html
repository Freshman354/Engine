<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theme Customization - Chatbot Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 40px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 24px;
            color: #1f2937;
        }
        
        .header p {
            color: #6b7280;
            margin-top: 4px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 32px;
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled {
            background: #f9fafb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .color-input-group {
            display: grid;
            grid-template-columns: 1fr 60px;
            gap: 12px;
            align-items: center;
        }
        
        .color-preview {
            width: 60px;
            height: 45px;
            border-radius: 8px;
            border: 2px solid #d1d5db;
            cursor: pointer;
        }
        
        .hint {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        /* White-Label Checkbox Styles */
        .checkbox-container {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #f9fafb;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-container:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .checkbox-label {
            font-size: 15px;
            color: #1f2937;
            font-weight: 500;
        }

        .checkbox-label.grayed {
            color: #9ca3af;
        }

        .checkbox-container.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .checkbox-container.disabled:hover {
            border-color: #e5e7eb;
            background: #f9fafb;
        }

        .help-text {
            display: block;
            margin-top: 8px;
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .help-text.success {
            background: #d1fae5;
            color: #065f46;
        }

        .help-text.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .upgrade-link {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .upgrade-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .plan-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #10b981;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* ‚îÄ‚îÄ Webhook / Integrations ‚îÄ‚îÄ */
        .webhook-row {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .webhook-row input { flex: 1; }
        .btn-test {
            padding: 12px 16px;
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .btn-test:hover { background: #e5e7eb; border-color: #9ca3af; }
        .btn-test:disabled { opacity: 0.4; cursor: not-allowed; }
        .webhook-status {
            font-size: 13px;
            margin-top: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            display: none;
        }
        .webhook-status.ok  { background: #d1fae5; color: #065f46; display: block; }
        .webhook-status.err { background: #fee2e2; color: #991b1b; display: block; }
        
        .preview-panel {
            position: sticky;
            top: 20px;
            height: fit-content;
        }
        
        .preview-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .preview-frame {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            background: #f9fafb;
            min-height: 400px;
        }
        
        .preview-widget {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .preview-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        .preview-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .preview-name {
            color: white;
            font-weight: 600;
        }
        
        .preview-message {
            background: #f3f4f6;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            color: #374151;
        }

        .preview-branding {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
            text-align: center;
            font-size: 11px;
            color: #9ca3af;
        }

        .preview-branding a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .preview-branding.hidden {
            display: none;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            padding-top: 32px;
            border-top: 2px solid #e5e7eb;
        }
        
        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #374151;
            border: 2px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            font-weight: 600;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            font-weight: 600;
        }
        
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .preview-panel {
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé® Theme Customization</h1>
        <p>Customize your chatbot's appearance and branding</p>
    </div>
    
    <div class="container">
        <div class="form-section">
            <div class="success-message" id="success-message">
                ‚úÖ Changes saved successfully!
            </div>
            
            <div class="error-message" id="error-message">
                ‚ùå Error saving changes. Please try again.
            </div>
            
            <div class="section-title">Branding</div>
            
            <div class="form-group">
                <label>Client ID</label>
                <input type="text" id="client-id" placeholder="demo" value="demo">
                <div class="hint">Unique identifier for this client</div>
            </div>
            
            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="company-name" placeholder="Demo Company">
            </div>
            
            <div class="form-group">
                <label>Logo URL</label>
                <input type="url" id="logo-url" placeholder="https://example.com/logo.png">
                <div class="hint">Direct link to your logo image</div>
            </div>
            
            <div class="form-group">
                <label>Primary Color</label>
                <div class="color-input-group">
                    <input type="text" id="primary-color" placeholder="#667eea">
                    <input type="color" id="primary-color-picker" class="color-preview">
                </div>
            </div>
            
            <div class="form-group">
                <label>Secondary Color</label>
                <div class="color-input-group">
                    <input type="text" id="secondary-color" placeholder="#764ba2">
                    <input type="color" id="secondary-color-picker" class="color-preview">
                </div>
            </div>
            
            <div class="section-title">Bot Settings</div>
            
            <div class="form-group">
                <label>Bot Name</label>
                <input type="text" id="bot-name" placeholder="Support Assistant">
            </div>
            
            <div class="form-group">
                <label>Welcome Message</label>
                <textarea id="welcome-message" placeholder="Hi! How can I help you today?"></textarea>
            </div>
            
            <!-- White-Label Branding Section -->
            <div class="section-title">
                White-Label Options
                <span class="plan-badge" id="plan-badge" style="display: none;"></span>
            </div>
            
            <div class="form-group" id="branding-group">
                <label class="checkbox-container" id="branding-container">
                    <input type="checkbox" 
                           name="remove_branding" 
                           id="remove-branding"
                           onchange="updateBrandingPreview()">
                    <span class="checkbox-label">Remove "Powered by FAQ Chatbot" branding</span>
                </label>
                <div class="help-text" id="branding-help-text"></div>
                <a href="/upgrade" class="upgrade-link" id="upgrade-link" style="display: none;">Upgrade to Agency Plan ‚Üí</a>
            </div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                 INTEGRATIONS ‚Äî Zapier / Make webhooks (Pro+ only)
            ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="section-title">
                Integrations
                <span class="plan-badge" id="integrations-badge" style="display:none; background:#6366f1;">PRO+</span>
            </div>

            <div class="form-group">
                <label for="webhook-url">Zapier / Make Webhook URL</label>
                <div class="webhook-row">
                    <input type="url"
                           id="webhook-url"
                           placeholder="https://hooks.zapier.com/hooks/catch/..."
                           disabled>
                    <button class="btn-test"
                            id="btn-test-webhook"
                            onclick="testWebhook()"
                            disabled>üß™ Test</button>
                </div>
                <div class="webhook-status" id="webhook-status"></div>
                <div class="hint">Every time a lead is captured, Lumvi will POST the lead data to this URL.</div>
                <div class="help-text" id="webhook-help-text"></div>
                <a href="/upgrade" class="upgrade-link" id="upgrade-link-webhook" style="display:none;">
                    Upgrade to Pro to unlock Zapier / Make ‚Üí
                </a>
            </div>
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

            <div class="section-title">Contact Information</div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="contact-email" placeholder="support@example.com">
            </div>
            
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="contact-phone" placeholder="+1-555-0100">
            </div>
            
            <div class="form-group">
                <label>Business Hours</label>
                <input type="text" id="business-hours" placeholder="Mon-Fri, 9 AM - 6 PM EST">
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="saveChanges()">üíæ Save Changes</button>
                <button class="btn btn-secondary" onclick="loadConfig()">üîÑ Reset</button>
            </div>
        </div>
        
        <div class="preview-panel">
            <div class="preview-section">
                <div class="section-title">Live Preview</div>
                
                <div class="preview-frame">
                    <div class="preview-widget">
                        <div class="preview-header" id="preview-header">
                            <div class="preview-avatar" id="preview-avatar">DC</div>
                            <div class="preview-name" id="preview-name">Demo Assistant</div>
                        </div>
                        
                        <div class="preview-message" id="preview-message">
                            Hi! How can I help you today?
                        </div>

                        <div class="preview-branding" id="preview-branding">
                            Powered by <a href="#" onclick="return false;">FAQ Chatbot</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let currentConfig = {};
        let userPlanType = 'free';
        
        window.onload = function() {
            loadUserInfo();
            loadConfig();
            attachEventListeners();
            updateBrandingPreview();
        };

        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user/info');
                const data = await response.json();
                if (data.success) {
                    userPlanType = data.plan_type || 'free';
                }
            } catch (error) {
                console.log('Could not load user info, using default');
            }
            // Always configure controls after fetch resolves (success or catch)
            configureBrandingControls();
            configureWebhookControls();
        }

        function configureBrandingControls() {
            const checkbox    = document.getElementById('remove-branding');
            const container   = document.getElementById('branding-container');
            const helpText    = document.getElementById('branding-help-text');
            const upgradeLink = document.getElementById('upgrade-link');
            const planBadge   = document.getElementById('plan-badge');

            if (userPlanType === 'agency' || userPlanType === 'enterprise') {
                checkbox.disabled = false;
                container.classList.remove('disabled');
                helpText.className   = 'help-text success';
                helpText.textContent = '‚úÖ White-label is available on your ' + userPlanType + ' plan';
                upgradeLink.style.display = 'none';
                planBadge.textContent     = userPlanType.toUpperCase();
                planBadge.style.display   = 'inline-block';
            } else {
                checkbox.disabled = true;
                container.classList.add('disabled');
                container.querySelector('.checkbox-label').classList.add('grayed');
                helpText.className   = 'help-text warning';
                helpText.textContent = 'üîí Upgrade to Agency plan ($299/mo) to remove branding and fully white-label your chatbot';
                upgradeLink.style.display = 'inline-block';
            }
        }

        // ‚îÄ‚îÄ NEW: configure webhook field based on plan ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function configureWebhookControls() {
            const input      = document.getElementById('webhook-url');
            const testBtn    = document.getElementById('btn-test-webhook');
            const helpText   = document.getElementById('webhook-help-text');
            const upgradeBtn = document.getElementById('upgrade-link-webhook');
            const badge      = document.getElementById('integrations-badge');
            const canWebhook = ['pro', 'agency', 'enterprise'].includes(userPlanType);

            if (canWebhook) {
                input.disabled   = false;
                testBtn.disabled = false;
                helpText.className   = 'help-text success';
                helpText.textContent = '‚úÖ Zapier / Make webhooks are active on your ' + userPlanType + ' plan';
                upgradeBtn.style.display = 'none';
                badge.style.display      = 'inline-block';
            } else {
                input.disabled   = true;
                testBtn.disabled = true;
                helpText.className   = 'help-text warning';
                helpText.textContent = 'üîí Webhook integrations are available on Pro ($99/mo) and above';
                upgradeBtn.style.display = 'inline-block';
                badge.style.display      = 'none';
            }
        }
        
        function attachEventListeners() {
            document.getElementById('company-name').addEventListener('input', updatePreview);
            document.getElementById('primary-color').addEventListener('input', updatePreview);
            document.getElementById('secondary-color').addEventListener('input', updatePreview);
            document.getElementById('bot-name').addEventListener('input', updatePreview);
            document.getElementById('welcome-message').addEventListener('input', updatePreview);
            
            document.getElementById('primary-color-picker').addEventListener('input', function(e) {
                document.getElementById('primary-color').value = e.target.value;
                updatePreview();
            });
            
            document.getElementById('secondary-color-picker').addEventListener('input', function(e) {
                document.getElementById('secondary-color').value = e.target.value;
                updatePreview();
            });
            
            document.getElementById('primary-color').addEventListener('input', function(e) {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    document.getElementById('primary-color-picker').value = e.target.value;
                }
            });
            
            document.getElementById('secondary-color').addEventListener('input', function(e) {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                    document.getElementById('secondary-color-picker').value = e.target.value;
                }
            });
        }

        function updateBrandingPreview() {
            const removeBrandingCheckbox = document.getElementById('remove-branding');
            const previewBranding = document.getElementById('preview-branding');
            
            if (removeBrandingCheckbox && removeBrandingCheckbox.checked) {
                previewBranding.classList.add('hidden');
            } else {
                previewBranding.classList.remove('hidden');
            }
        }
        
        async function loadConfig() {
            const clientId = document.getElementById('client-id').value || 'demo';
            
            try {
                const response = await fetch(`/api/config?client_id=${clientId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentConfig = data.config;
                    populateForm(currentConfig);
                    updatePreview();
                    updateBrandingPreview();
                }
            } catch (error) {
                console.error('Error loading config:', error);
            }
        }
        
        function populateForm(config) {
            document.getElementById('company-name').value    = config.branding?.company_name    || '';
            document.getElementById('logo-url').value        = config.branding?.logo_url        || '';
            document.getElementById('primary-color').value   = config.branding?.primary_color   || '#667eea';
            document.getElementById('secondary-color').value = config.branding?.secondary_color || '#764ba2';
            document.getElementById('bot-name').value        = config.bot_settings?.bot_name    || '';
            document.getElementById('welcome-message').value = config.bot_settings?.welcome_message || '';
            document.getElementById('contact-email').value   = config.contact?.email            || '';
            document.getElementById('contact-phone').value   = config.contact?.phone            || '';
            document.getElementById('business-hours').value  = config.contact?.business_hours   || '';
            
            // Sync color pickers
            document.getElementById('primary-color-picker').value  = config.branding?.primary_color   || '#667eea';
            document.getElementById('secondary-color-picker').value = config.branding?.secondary_color || '#764ba2';

            // ‚îÄ‚îÄ Webhook: only populate if field is enabled for this plan ‚îÄ‚îÄ
            const webhookInput = document.getElementById('webhook-url');
            if (!webhookInput.disabled) {
                webhookInput.value = config.integrations?.webhook_url || '';
            }
        }
        
        function updatePreview() {
            const botName      = document.getElementById('bot-name').value        || 'Support Assistant';
            const welcomeMsg   = document.getElementById('welcome-message').value || 'Hi! How can I help you today?';
            const primaryColor = document.getElementById('primary-color').value   || '#667eea';
            const companyName  = document.getElementById('company-name').value    || 'Demo Company';
            
            document.getElementById('preview-name').textContent    = botName;
            document.getElementById('preview-message').textContent = welcomeMsg;
            document.getElementById('preview-header').style.background = primaryColor;
            
            const initials = companyName.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
            document.getElementById('preview-avatar').textContent = initials;
        }
        
        async function saveChanges() {
            const clientId       = document.getElementById('client-id').value || 'demo';
            const removeBranding = document.getElementById('remove-branding')?.checked || false;

            // Only include webhook_url if the field is enabled (pro/agency/enterprise)
            const webhookInput = document.getElementById('webhook-url');
            const webhookUrl   = webhookInput.disabled ? '' : webhookInput.value.trim();
            
            const updatedConfig = {
                client_id:       clientId,
                remove_branding: removeBranding,
                branding: {
                    company_name:    document.getElementById('company-name').value,
                    logo_url:        document.getElementById('logo-url').value,
                    primary_color:   document.getElementById('primary-color').value,
                    secondary_color: document.getElementById('secondary-color').value,
                    bot_avatar:      currentConfig.branding?.bot_avatar || ''
                },
                contact: {
                    email:          document.getElementById('contact-email').value,
                    phone:          document.getElementById('contact-phone').value,
                    whatsapp:       currentConfig.contact?.whatsapp || '',
                    business_hours: document.getElementById('business-hours').value
                },
                bot_settings: {
                    bot_name:         document.getElementById('bot-name').value,
                    welcome_message:  document.getElementById('welcome-message').value,
                    tone:             currentConfig.bot_settings?.tone || 'friendly',
                    fallback_message: currentConfig.bot_settings?.fallback_message || '',
                    lead_triggers:    currentConfig.bot_settings?.lead_triggers || []
                },
                // ‚îÄ‚îÄ integrations block ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                // Backend (save_customization) will strip webhook_url for
                // free/starter regardless of what arrives here, so it is
                // safe to always send the field.
                integrations: {
                    webhook_url: webhookUrl
                }
            };
            
            try {
                const response = await fetch('/api/admin/customize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedConfig)
                });
                
                const data = await response.json();
                data.success ? showSuccess() : showError(data.error);
            } catch (error) {
                console.error('Error saving:', error);
                showError();
            }
        }

        // ‚îÄ‚îÄ NEW: test webhook by sending a ping via the backend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function testWebhook() {
            const url    = document.getElementById('webhook-url').value.trim();
            const status = document.getElementById('webhook-status');
            const btn    = document.getElementById('btn-test-webhook');

            if (!url) {
                status.className   = 'webhook-status err';
                status.textContent = '‚ö†Ô∏è Enter a webhook URL first.';
                return;
            }

            btn.disabled    = true;
            btn.textContent = '‚è≥ Sending...';
            status.className   = 'webhook-status';
            status.textContent = '';

            try {
                const res  = await fetch('/api/admin/test-webhook', {
                    method:  'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body:    JSON.stringify({ webhook_url: url })
                });
                const data = await res.json();

                if (data.success) {
                    status.className   = 'webhook-status ok';
                    status.textContent = '‚úÖ Test ping sent! Check Zapier / Make / webhook.site to confirm it arrived.';
                } else {
                    status.className   = 'webhook-status err';
                    status.textContent = '‚ùå ' + (data.error || 'Webhook test failed.');
                }
            } catch (e) {
                status.className   = 'webhook-status err';
                status.textContent = '‚ùå Network error ‚Äî could not reach the test endpoint.';
            }

            btn.disabled    = false;
            btn.textContent = 'üß™ Test';
        }
        
        function showSuccess(msg) {
            const el = document.getElementById('success-message');
            el.textContent   = '‚úÖ ' + (msg || 'Changes saved successfully!');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }
        
        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent   = '‚ùå ' + (msg || 'Error saving changes. Please try again.');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 4000);
        }
    </script>
</body>
</html>