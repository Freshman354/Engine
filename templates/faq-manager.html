<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ Manager - Chatbot Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f9fafb;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 40px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 { font-size: 24px; color: #1f2937; }
        .header p { color: #6b7280; margin-top: 4px; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 40px; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
        }
        
        .controls-left { display: flex; gap: 16px; align-items: center; }
        .controls label { font-weight: 600; color: #374151; }
        
        .controls select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 14px;
        }
        
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }

        /* ‚úÖ NEW */
        .btn-upload { background: #0ea5e9; color: white; }
        .btn-upload:hover { background: #0284c7; }
        
        .success-message {
            background: #d1fae5;
            color: #065f46;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            font-weight: 600;
        }
        
        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            display: none;
            font-weight: 600;
        }
        
        .faq-list {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        
        .faq-item {
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        
        .faq-item:hover { border-color: #667eea; }
        
        .faq-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .faq-question { font-size: 16px; font-weight: 600; color: #1f2937; flex: 1; }
        .faq-actions { display: flex; gap: 8px; }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-weight: 600;
        }
        
        .btn-edit { background: #3b82f6; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .faq-answer { color: #6b7280; margin-bottom: 12px; line-height: 1.6; }
        .faq-triggers { display: flex; flex-wrap: wrap; gap: 8px; }
        
        .trigger-tag {
            background: #e0e7ff;
            color: #4338ca;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h2 { font-size: 24px; color: #1f2937; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280; }
        
        .form-group { margin-bottom: 20px; }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea { resize: vertical; min-height: 100px; }
        .hint { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .btn-cancel { background: #e5e7eb; color: #374151; }
        .empty-state { text-align: center; padding: 60px 20px; color: #6b7280; }
        .empty-state-icon { font-size: 64px; margin-bottom: 16px; }

        /* ‚úÖ NEW: Upload modal styles */
        .format-box {
            padding: 14px 18px;
            border-radius: 8px;
            margin-bottom: 14px;
            font-size: 13px;
            line-height: 1.7;
        }

        .format-box.blue { background: #eff6ff; border-left: 4px solid #3b82f6; }
        .format-box.yellow { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .format-box strong { display: block; margin-bottom: 6px; color: #1f2937; font-size: 14px; }
        .format-box ul { margin-left: 18px; color: #374151; }
        .format-box code { background: rgba(0,0,0,0.07); padding: 1px 5px; border-radius: 3px; font-family: monospace; font-size: 12px; }

        .upload-dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 36px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 16px 0;
        }

        .upload-dropzone:hover, .upload-dropzone.dragover {
            border-color: #667eea;
            background: #f5f3ff;
        }

        .upload-dropzone .drop-icon { font-size: 44px; margin-bottom: 12px; }
        .upload-dropzone p { color: #6b7280; font-size: 14px; margin-bottom: 4px; }
        .upload-dropzone .file-types { color: #9ca3af; font-size: 12px; }

        .progress-area { display: none; margin-top: 16px; }

        .progress-bar-bg {
            background: #e5e7eb;
            border-radius: 20px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 20px;
        }

        .progress-status {
            text-align: center;
            font-size: 13px;
            color: #6b7280;
            margin-top: 10px;
            font-weight: 500;
        }

        .download-template-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 0;
            margin-bottom: 4px;
        }

        .download-template-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìù FAQ Manager</h1>
        <p>Add, edit, and manage your chatbot's FAQs</p>
        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 12px; display: inline-block;">
            <strong>Plan:</strong> <span id="user-plan">Loading...</span> | 
            <strong>FAQs:</strong> <span id="faq-count">0</span> / <span id="faq-limit">0</span>
            <span id="limit-warning" style="color: #ef4444; margin-left: 8px; display: none;">‚ö†Ô∏è Limit Reached</span>
        </div>
    </div>
    
    <div class="container">
        <div class="controls">
            <div class="controls-left">
                <label for="client-select">Client:</label>
                <select id="client-select">
                    <option value="default">Default</option>
                    <option value="demo">Demo</option>
                </select>
                <button class="btn btn-primary" onclick="loadFAQs()">üîÑ Refresh</button>
            </div>
            <!-- ‚úÖ CHANGED: Added Upload button -->
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-upload" onclick="showUploadModal()">üì§ Upload FAQs</button>
                <button class="btn btn-success" onclick="openAddModal()">+ Add New FAQ</button>
            </div>
        </div>
        
        <div class="success-message" id="success-message">‚úÖ Changes saved successfully!</div>
        <div class="error-message" id="error-message">‚ùå Error saving changes. Please try again.</div>
        
        <div class="faq-list" id="faq-list">
            <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <p>Loading FAQs...</p>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Modal (UNCHANGED FROM YOUR ORIGINAL) -->
    <div class="modal" id="faq-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New FAQ</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            
            <form id="faq-form">
                <input type="hidden" id="faq-id">
                
                <div class="form-group">
                    <label>Question</label>
                    <input type="text" id="faq-question" placeholder="What are your business hours?" required>
                    <div class="hint">The question your customers will ask</div>
                </div>
                
                <div class="form-group">
                    <label>Answer</label>
                    <textarea id="faq-answer" placeholder="We're open Monday to Friday, 9 AM - 6 PM EST." required></textarea>
                    <div class="hint">The response the chatbot will give</div>
                </div>
                
                <div class="form-group">
                    <label>Trigger Keywords</label>
                    <input type="text" id="faq-triggers" placeholder="hours, time, open, available" required>
                    <div class="hint">Keywords that trigger this answer (comma-separated)</div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save FAQ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ‚úÖ NEW: Upload FAQs Modal -->
    <div class="modal" id="upload-modal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h2>üì§ Upload FAQs</h2>
                <button class="modal-close" onclick="closeUploadModal()">√ó</button>
            </div>

            <div class="format-box blue">
                <strong>üìã CSV / Excel Format</strong>
                <ul>
                    <li>Column 1: <code>question</code> (required)</li>
                    <li>Column 2: <code>answer</code> (required)</li>
                    <li>Column 3: <code>category</code> (optional)</li>
                </ul>
            </div>

            <div class="format-box yellow">
                <strong>üìÑ PDF Format</strong>
                <ul>
                    <li>Use <code>Q:</code> or <code>Question:</code> before each question</li>
                    <li>Use <code>A:</code> or <code>Answer:</code> before each answer</li>
                    <li>Or upload any document ‚Äî AI will extract FAQs automatically!</li>
                </ul>
            </div>

            <span class="download-template-link" onclick="downloadCSVTemplate()">‚¨áÔ∏è Download CSV Template</span>

            <div class="upload-dropzone" id="drop-zone" onclick="document.getElementById('faq-file-input').click()">
                <div class="drop-icon">üìÅ</div>
                <p>Click to upload or drag and drop</p>
                <p id="selected-file-name" style="color: #667eea; font-weight: 600; display: none;"></p>
                <p class="file-types">CSV, Excel (.xlsx), or PDF ‚Äî max 10MB</p>
                <input type="file" id="faq-file-input" accept=".csv,.xlsx,.xls,.pdf" style="display: none;" onchange="handleFileSelect(event)">
            </div>

            <div class="progress-area" id="progress-area">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <p class="progress-status" id="progress-status">Processing...</p>
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-upload" id="upload-submit-btn" onclick="startUpload()" disabled>Upload FAQs</button>
            </div>
        </div>
    </div>
    
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const CLIENT_ID = urlParams.get('client_id');
    
        if (!CLIENT_ID) {
            alert('Error: No client ID provided');
            window.location.href = '/dashboard';
        }
    
        let currentFAQs = [];
        let editingIndex = -1;
        let userPlan = 'free';
        let faqLimit = 999;
        let selectedFile = null;

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('client_id') || 'demo';
            document.getElementById('client-select').value = clientId;
            loadFAQs();
        };
        
        async function loadFAQs() {
            const clientId = CLIENT_ID;
            if (!clientId) { console.error('No client ID selected'); return; }
    
            try {
                const response = await fetch(`/api/faqs?client_id=${clientId}`);
                const data = await response.json();
                if (data.success) {
                    currentFAQs = data.faqs || [];
                    renderFAQs();
                    updateFaqCount();
                } else {
                    console.error('Failed to load FAQs:', data.error);
                    showError();
                }
            } catch (error) {
                console.error('Error loading FAQs:', error);
                showError();
            }
        }
        
        function updateFaqCount() {
            document.getElementById('faq-count').textContent = currentFAQs.length;
            document.getElementById('faq-limit').textContent = faqLimit;
            const warning = document.getElementById('limit-warning');
            warning.style.display = currentFAQs.length >= faqLimit ? 'inline' : 'none';
        }

        function renderFAQs() {
            const container = document.getElementById('faq-list');
            
            if (currentFAQs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No FAQs yet. Click "Add New FAQ" or "üì§ Upload FAQs" to get started!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentFAQs.map((faq, index) => `
                <div class="faq-item">
                    <div class="faq-header">
                        <div class="faq-question">${escapeHtml(faq.question)}</div>
                        <div class="faq-actions">
                            <button class="btn-small btn-edit" onclick="editFAQ(${index})">‚úèÔ∏è Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteFAQ(${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div class="faq-answer">${escapeHtml(faq.answer)}</div>
                    <div class="faq-triggers">
                        ${faq.triggers.map(t => `<span class="trigger-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Add New FAQ';
            document.getElementById('faq-form').reset();
            document.getElementById('faq-id').value = '';
            editingIndex = -1;
            document.getElementById('faq-modal').style.display = 'flex';
        }
        
        function editFAQ(index) {
            const faq = currentFAQs[index];
            document.getElementById('modal-title').textContent = 'Edit FAQ';
            document.getElementById('faq-id').value = faq.id;
            document.getElementById('faq-question').value = faq.question;
            document.getElementById('faq-answer').value = faq.answer;
            document.getElementById('faq-triggers').value = faq.triggers.join(', ');
            editingIndex = index;
            document.getElementById('faq-modal').style.display = 'flex';
        }
        
        async function deleteFAQ(index) {
            if (!confirm('Are you sure you want to delete this FAQ?')) return;
            const updatedFAQs = currentFAQs.filter((_, i) => i !== index);
            try {
                const response = await fetch('/api/faqs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: CLIENT_ID, faqs: updatedFAQs })
                });
                const data = await response.json();
                if (data.success) {
                    currentFAQs = updatedFAQs;
                    renderFAQs();
                    showSuccess();
                    updateFaqCount();
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error deleting FAQ:', error);
                showError();
            }
        }
        
        function closeModal() {
            document.getElementById('faq-modal').style.display = 'none';
        }
        
        document.getElementById('faq-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const question = document.getElementById('faq-question').value.trim();
            const answer = document.getElementById('faq-answer').value.trim();
            const triggers = document.getElementById('faq-triggers').value.split(',').map(t => t.trim()).filter(Boolean);
    
            const newFAQ = {
                id: editingIndex >= 0 ? currentFAQs[editingIndex].id : `faq_${Date.now()}`,
                question, answer, triggers
            };
    
            const updatedFAQs = editingIndex >= 0
                ? currentFAQs.map((f, i) => i === editingIndex ? newFAQ : f)
                : [...currentFAQs, newFAQ];
    
            try {
                const response = await fetch('/api/faqs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: CLIENT_ID, faqs: updatedFAQs })
                });
                const data = await response.json();
                if (data.success) {
                    currentFAQs = updatedFAQs;
                    renderFAQs();
                    closeModal();
                    showSuccess();
                    updateFaqCount();
                } else {
                    showError(data.error || 'Failed to save FAQ');
                }
            } catch (error) {
                console.error('Error saving FAQ:', error);
                showError();
            }
        });
        
        function showSuccess(msg) {
            const el = document.getElementById('success-message');
            el.textContent = '‚úÖ ' + (msg || 'Changes saved successfully!');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3500);
        }
        
        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = '‚ùå ' + (msg || 'Error saving changes. Please try again.');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3500);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // =============================================
        // ‚úÖ NEW: UPLOAD FUNCTIONS
        // =============================================

        function showUploadModal() {
            document.getElementById('upload-modal').style.display = 'flex';
            resetUploadModal();
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
            resetUploadModal();
        }

        function resetUploadModal() {
            selectedFile = null;
            document.getElementById('faq-file-input').value = '';
            document.getElementById('selected-file-name').style.display = 'none';
            document.getElementById('selected-file-name').textContent = '';
            document.getElementById('progress-area').style.display = 'none';
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-status').textContent = 'Processing...';
            document.getElementById('progress-status').style.color = '#6b7280';
            document.getElementById('upload-submit-btn').disabled = true;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) {
                showError('File too large! Maximum size is 10MB.');
                return;
            }

            selectedFile = file;
            const nameEl = document.getElementById('selected-file-name');
            nameEl.textContent = 'üìé ' + file.name;
            nameEl.style.display = 'block';
            document.getElementById('upload-submit-btn').disabled = false;
        }

        async function startUpload() {
            if (!selectedFile) return;

            document.getElementById('progress-area').style.display = 'block';
            document.getElementById('progress-fill').style.width = '30%';
            document.getElementById('progress-status').textContent = 'Uploading file...';
            document.getElementById('upload-submit-btn').disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('client_id', CLIENT_ID);

            try {
                document.getElementById('progress-fill').style.width = '60%';
                document.getElementById('progress-status').textContent = 'Processing FAQs...';

                const response = await fetch('/api/faq/upload', {
                    method: 'POST',
                    body: formData
                });

                document.getElementById('progress-fill').style.width = '100%';
                const data = await response.json();

                if (data.success) {
                    document.getElementById('progress-status').textContent = '‚úÖ ' + data.message;
                    document.getElementById('progress-status').style.color = '#065f46';
                    setTimeout(() => {
                        closeUploadModal();
                        loadFAQs();
                        showSuccess(data.message);
                    }, 1500);
                } else {
                    document.getElementById('progress-status').textContent = '‚ùå ' + data.error;
                    document.getElementById('progress-status').style.color = '#991b1b';
                    document.getElementById('upload-submit-btn').disabled = false;
                }
            } catch (error) {
                document.getElementById('progress-status').textContent = '‚ùå Upload failed. Please try again.';
                document.getElementById('progress-status').style.color = '#991b1b';
                document.getElementById('upload-submit-btn').disabled = false;
            }
        }

        // Drag and drop
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('faq-file-input').files = dt.files;
                handleFileSelect({ target: { files: [file] } });
            }
        });

        // Download CSV template
        function downloadCSVTemplate() {
            const csv = `question,answer,category
What are your business hours?,"We're open Monday-Friday 9 AM - 6 PM EST. Saturday 10 AM - 4 PM. Closed Sundays.",General
How much does it cost?,"Starter: $15/mo | Agency: $60/mo | Enterprise: $199 lifetime",Pricing
Do you offer refunds?,"Yes! We offer a 7-day money-back guarantee no questions asked.",Policies
Can I get a demo?,"Absolutely! Visit lumvi.net/demo to schedule a live demo.",Sales
How do I get started?,"Simply sign up at lumvi.net and follow the setup wizard.",Getting Started`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'faq-template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>