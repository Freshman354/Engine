<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FAQ Manager - Chatbot Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ‚îÄ‚îÄ THEME VARIABLES ‚îÄ‚îÄ */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
        }

        /* DARK THEME (default) */
        [data-theme="dark"] {
            --bg: #0f172a;
            --bg-secondary: #1e293b;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-solid: #1e293b;
            --border: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(99, 102, 241, 0.6);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --text-body: #cbd5e1;
            --input-bg: rgba(255, 255, 255, 0.06);
            --input-border: rgba(255, 255, 255, 0.12);
            --tag-bg: rgba(99, 102, 241, 0.2);
            --tag-color: #a78bfa;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.4);
            --plan-bar-bg: rgba(30, 41, 59, 0.8);
            --success-bg: rgba(16, 185, 129, 0.15);
            --success-color: #6ee7b7;
            --error-bg: rgba(239, 68, 68, 0.15);
            --error-color: #fca5a5;
            --format-blue-bg: rgba(59, 130, 246, 0.1);
            --format-blue-border: #3b82f6;
            --format-yellow-bg: rgba(245, 158, 11, 0.1);
            --format-yellow-border: #f59e0b;
            --drop-bg: rgba(255, 255, 255, 0.03);
            --drop-hover-bg: rgba(99, 102, 241, 0.1);
            --tip-bg: rgba(245, 158, 11, 0.1);
            --tip-color: #fcd34d;
        }

        /* LIGHT THEME */
        [data-theme="light"] {
            --bg: #f9fafb;
            --bg-secondary: #ffffff;
            --card-bg: #ffffff;
            --card-solid: #ffffff;
            --border: #e5e7eb;
            --border-hover: #667eea;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --text-body: #374151;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --tag-bg: #e0e7ff;
            --tag-color: #4338ca;
            --shadow: 0 1px 6px rgba(0, 0, 0, 0.08);
            --shadow-glow: 0 4px 15px rgba(102, 126, 234, 0.2);
            --plan-bar-bg: #fef3c7;
            --success-bg: #d1fae5;
            --success-color: #065f46;
            --error-bg: #fee2e2;
            --error-color: #991b1b;
            --format-blue-bg: #eff6ff;
            --format-blue-border: #3b82f6;
            --format-yellow-bg: #fef3c7;
            --format-yellow-border: #f59e0b;
            --drop-bg: #f9fafb;
            --drop-hover-bg: #f5f3ff;
            --tip-bg: #fef3c7;
            --tip-color: #92400e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text-main);
            min-height: 100vh;
            transition: background 0.3s, color 0.3s;
        }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 24px 40px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left h1 {
            font-size: 24px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .header-left p {
            color: var(--text-muted);
            font-size: 14px;
            margin-top: 2px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .plan-status-bar {
            background: var(--plan-bar-bg);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 13px;
            color: var(--text-body);
        }

        .plan-status-bar strong { color: var(--text-main); }

        .limit-warning {
            color: #f87171;
            font-weight: 700;
            margin-left: 4px;
        }

        /* ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .theme-toggle-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
        }

        .toggle-switch input { opacity: 0; width: 0; height: 0; }

        .toggle-track {
            position: absolute;
            inset: 0;
            background: rgba(99, 102, 241, 0.3);
            border: 1px solid rgba(99, 102, 241, 0.4);
            border-radius: 999px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .toggle-switch input:checked + .toggle-track {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-color: var(--primary);
        }

        .toggle-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            transition: transform 0.3s;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .toggle-switch input:checked ~ .toggle-thumb { transform: translateX(22px); }

        /* ‚îÄ‚îÄ CONTAINER ‚îÄ‚îÄ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 36px 40px;
        }

        /* ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ */
        .controls {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            padding: 20px 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        .controls-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .controls-left label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 14px;
        }

        .controls select {
            padding: 9px 14px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .controls select:focus { outline: none; border-color: var(--primary); }

        .controls-right { display: flex; gap: 10px; flex-wrap: wrap; }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        .btn {
            padding: 10px 18px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 3px 12px rgba(99, 102, 241, 0.35);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(99, 102, 241, 0.5); }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 3px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(16, 185, 129, 0.45); }

        .btn-upload {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            box-shadow: 0 3px 12px rgba(14, 165, 233, 0.3);
        }
        .btn-upload:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(14, 165, 233, 0.45); }

        .btn-cancel {
            background: var(--input-bg);
            color: var(--text-muted);
            border: 1px solid var(--border);
        }
        .btn-cancel:hover { background: var(--border); color: var(--text-main); }

        /* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            font-weight: 600;
            font-size: 14px;
        }

        .alert-success {
            background: var(--success-bg);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .alert-error {
            background: var(--error-bg);
            color: var(--error-color);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* ‚îÄ‚îÄ FAQ LIST ‚îÄ‚îÄ */
        .faq-list {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        /* ‚îÄ‚îÄ FAQ ITEM ‚îÄ‚îÄ */
        .faq-item {
            padding: 20px 22px;
            border: 1px solid var(--border);
            border-radius: 14px;
            margin-bottom: 14px;
            transition: all 0.25s;
            background: var(--bg-secondary);
        }

        .faq-item:hover {
            border-color: var(--border-hover);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .faq-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 12px;
        }

        .faq-question {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-main);
            flex: 1;
            line-height: 1.4;
        }

        .faq-actions { display: flex; gap: 8px; flex-shrink: 0; }

        .btn-small {
            padding: 7px 13px;
            font-size: 12px;
            border-radius: 8px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .btn-edit {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.25);
        }
        .btn-edit:hover { background: rgba(59, 130, 246, 0.3); }

        .btn-delete {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.25);
        }
        .btn-delete:hover { background: rgba(239, 68, 68, 0.3); }

        .faq-answer {
            color: var(--text-muted);
            margin-bottom: 14px;
            line-height: 1.6;
            font-size: 14px;
        }

        .faq-triggers { display: flex; flex-wrap: wrap; gap: 8px; }

        .trigger-tag {
            background: var(--tag-bg);
            color: var(--tag-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
        .empty-state {
            text-align: center;
            padding: 70px 20px;
            color: var(--text-muted);
        }

        .empty-state-icon { font-size: 60px; margin-bottom: 16px; }
        .empty-state p { font-size: 16px; }

        /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-solid);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 36px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.5);
            animation: slideUp 0.35s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
        }

        .modal-header h2 {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-main);
        }

        .modal-close {
            background: var(--input-bg);
            border: 1px solid var(--border);
            font-size: 20px;
            cursor: pointer;
            color: var(--text-muted);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover { color: var(--text-main); background: var(--border); }

        .form-group { margin-bottom: 20px; }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-body);
            font-size: 14px;
        }

        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Inter', sans-serif;
            color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .form-group input::placeholder, .form-group textarea::placeholder { color: var(--text-muted); }
        .form-group textarea { resize: vertical; min-height: 100px; }

        .hint { font-size: 12px; color: var(--text-muted); margin-top: 5px; }

        .modal-actions { display: flex; gap: 12px; margin-top: 28px; }

        /* ‚îÄ‚îÄ UPLOAD MODAL SPECIFIC ‚îÄ‚îÄ */
        .format-box {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 14px;
            font-size: 13px;
            line-height: 1.7;
        }

        .format-box.blue {
            background: var(--format-blue-bg);
            border-left: 3px solid var(--format-blue-border);
        }

        .format-box.yellow {
            background: var(--format-yellow-bg);
            border-left: 3px solid var(--format-yellow-border);
        }

        .format-box strong {
            display: block;
            margin-bottom: 6px;
            color: var(--text-main);
            font-size: 14px;
        }

        .format-box ul { margin-left: 18px; color: var(--text-body); }

        .format-box code {
            background: rgba(128,128,128,0.15);
            padding: 1px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            color: var(--tag-color);
        }

        .upload-dropzone {
            border: 2px dashed var(--input-border);
            border-radius: 14px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 16px 0;
            background: var(--drop-bg);
        }

        .upload-dropzone:hover, .upload-dropzone.dragover {
            border-color: var(--primary);
            background: var(--drop-hover-bg);
        }

        .upload-dropzone .drop-icon { font-size: 44px; margin-bottom: 12px; }
        .upload-dropzone p { color: var(--text-muted); font-size: 14px; margin-bottom: 4px; }
        .upload-dropzone .file-types { color: var(--text-muted); font-size: 12px; opacity: 0.7; }
        .upload-dropzone .selected-name { color: var(--primary); font-weight: 700; display: none; }

        .progress-area { display: none; margin-top: 16px; }

        .progress-bar-bg {
            background: var(--border);
            border-radius: 20px;
            height: 8px;
            overflow: hidden;
        }

        .progress-bar-fill {
            background: linear-gradient(90deg, var(--primary), #a78bfa);
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 20px;
        }

        .progress-status {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 10px;
            font-weight: 500;
        }

        .download-template-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--primary);
            font-weight: 600;
            cursor: pointer;
            padding: 4px 0;
            margin-bottom: 4px;
        }

        .download-template-link:hover { text-decoration: underline; }

        .embed-tip {
            margin-top: 18px;
            padding: 14px 16px;
            background: var(--tip-bg);
            border-left: 3px solid var(--warning);
            border-radius: 8px;
            font-size: 13px;
            color: var(--tip-color);
            line-height: 1.6;
        }

        @keyframes slideUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .header { padding: 18px 20px; }
            .container { padding: 24px 16px; }
            .controls { flex-direction: column; align-items: stretch; }
            .controls-right { justify-content: stretch; }
            .controls-right .btn { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <h1>üìù FAQ Manager</h1>
            <p>Add, edit, and manage your chatbot's FAQs</p>
        </div>

        <div class="header-right">
            <div class="plan-status-bar">
                <strong>Plan:</strong> <span id="user-plan">Loading...</span> &nbsp;¬∑&nbsp;
                <strong>FAQs:</strong> <span id="faq-count">0</span> / <span id="faq-limit">0</span>
                <span id="limit-warning" class="limit-warning" style="display:none;">‚ö†Ô∏è Limit Reached</span>
            </div>

            <!-- THEME TOGGLE -->
            <label class="theme-toggle" title="Toggle light/dark theme">
                <span class="theme-toggle-label" id="theme-label">üåô Dark</span>
                <div class="toggle-switch">
                    <input type="checkbox" id="theme-switch" onchange="toggleTheme(this)">
                    <div class="toggle-track"></div>
                    <div class="toggle-thumb" id="toggle-icon">üåô</div>
                </div>
            </label>
        </div>
    </div>

    <div class="container">

        <!-- CONTROLS -->
        <div class="controls">
            <div class="controls-left">
                <label for="client-select">Client:</label>
                <select id="client-select">
                    <option value="default">Default</option>
                    <option value="demo">Demo</option>
                </select>
                <button class="btn btn-primary" onclick="loadFAQs()">üîÑ Refresh</button>
            </div>
            <div class="controls-right">
                <button class="btn btn-upload" onclick="showUploadModal()">üì§ Upload FAQs</button>
                <button class="btn btn-success" onclick="openAddModal()">+ Add New FAQ</button>
            </div>
        </div>

        <div class="alert alert-success" id="success-message">‚úÖ Changes saved successfully!</div>
        <div class="alert alert-error" id="error-message">‚ùå Error saving changes. Please try again.</div>

        <div class="faq-list" id="faq-list">
            <div class="empty-state">
                <div class="empty-state-icon">‚è≥</div>
                <p>Loading FAQs...</p>
            </div>
        </div>

    </div>

    <!-- ADD / EDIT MODAL -->
    <div class="modal" id="faq-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New FAQ</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>

            <form id="faq-form">
                <input type="hidden" id="faq-id">

                <div class="form-group">
                    <label>Question</label>
                    <input type="text" id="faq-question" placeholder="What are your business hours?" required>
                    <div class="hint">The question your customers will ask</div>
                </div>

                <div class="form-group">
                    <label>Answer</label>
                    <textarea id="faq-answer" placeholder="We're open Monday to Friday, 9 AM - 6 PM EST." required></textarea>
                    <div class="hint">The response the chatbot will give</div>
                </div>

                <div class="form-group">
                    <label>Trigger Keywords</label>
                    <input type="text" id="faq-triggers" placeholder="hours, time, open, available" required>
                    <div class="hint">Keywords that trigger this answer (comma-separated)</div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-success">Save FAQ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div class="modal" id="upload-modal">
        <div class="modal-content" style="max-width: 560px;">
            <div class="modal-header">
                <h2>üì§ Upload FAQs</h2>
                <button class="modal-close" onclick="closeUploadModal()">√ó</button>
            </div>

            <div class="format-box blue">
                <strong>üìã CSV / Excel Format</strong>
                <ul>
                    <li>Column 1: <code>question</code> (required)</li>
                    <li>Column 2: <code>answer</code> (required)</li>
                    <li>Column 3: <code>category</code> (required)</li>
                </ul>
            </div>

            <div class="format-box yellow">
                <strong>üìÑ PDF Format</strong>
                <ul>
                    <li>Use <code>Q:</code> or <code>Question:</code> before each question</li>
                    <li>Use <code>A:</code> or <code>Answer:</code> before each answer</li>
                    <li>Use <code>C:</code> or <code>category</code> before each category</li>
                    <li>Or upload any document ‚Äî AI will extract FAQs automatically!</li>
                </ul>
            </div>

            <span class="download-template-link" onclick="downloadCSVTemplate()">‚¨áÔ∏è Download CSV Template</span>

            <div class="upload-dropzone" id="drop-zone" onclick="document.getElementById('faq-file-input').click()">
                <div class="drop-icon">üìÅ</div>
                <p>Click to upload or drag and drop</p>
                <p class="selected-name" id="selected-file-name"></p>
                <p class="file-types">CSV, Excel (.xlsx), or PDF ‚Äî max 10MB</p>
                <input type="file" id="faq-file-input" accept=".csv,.xlsx,.xls,.pdf" style="display: none;" onchange="handleFileSelect(event)">
            </div>

            <div class="progress-area" id="progress-area">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progress-fill"></div>
                </div>
                <p class="progress-status" id="progress-status">Processing...</p>
            </div>

            <div class="embed-tip">
                üí° <strong>Tip:</strong> Download the CSV template to see the exact format needed. PDF uploads use AI extraction ‚Äî Q: and A: labels give the best results.
            </div>

            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-upload" id="upload-submit-btn" onclick="startUpload()" disabled>Upload FAQs</button>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ THEME TOGGLE ‚îÄ‚îÄ
        function toggleTheme(checkbox) {
            const isLight = checkbox.checked;
            document.documentElement.setAttribute('data-theme', isLight ? 'light' : 'dark');
            document.getElementById('theme-label').textContent = isLight ? '‚òÄÔ∏è Light' : 'üåô Dark';
            document.getElementById('toggle-icon').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('faqManagerTheme', isLight ? 'light' : 'dark');
        }

        // Restore saved theme
        (function() {
            const saved = localStorage.getItem('faqManagerTheme') || 'dark';
            document.documentElement.setAttribute('data-theme', saved);
            if (saved === 'light') {
                const sw = document.getElementById('theme-switch');
                if (sw) {
                    sw.checked = true;
                    document.getElementById('theme-label').textContent = '‚òÄÔ∏è Light';
                    document.getElementById('toggle-icon').textContent = '‚òÄÔ∏è';
                }
            }
        })();

        // ‚îÄ‚îÄ FAQ LOGIC ‚îÄ‚îÄ
        const urlParams = new URLSearchParams(window.location.search);
        const CLIENT_ID = urlParams.get('client_id');

        if (!CLIENT_ID) {
            alert('Error: No client ID provided');
            window.location.href = '/dashboard';
        }

        let currentFAQs = [];
        let editingIndex = -1;
        let userPlan = 'free';
        let faqLimit = 999;
        let selectedFile = null;

        window.onload = function() {
            const clientId = urlParams.get('client_id') || 'demo';
            document.getElementById('client-select').value = clientId;
            loadFAQs();
        };

        async function loadFAQs() {
            if (!CLIENT_ID) return;
            try {
                const response = await fetch(`/api/faqs?client_id=${CLIENT_ID}`);
                const data = await response.json();
                if (data.success) {
                    currentFAQs = data.faqs || [];
                    renderFAQs();
                    updateFaqCount();
                } else {
                    showError();
                }
            } catch (error) {
                showError();
            }
        }

        function updateFaqCount() {
            document.getElementById('faq-count').textContent = currentFAQs.length;
            document.getElementById('faq-limit').textContent = faqLimit;
            const w = document.getElementById('limit-warning');
            w.style.display = currentFAQs.length >= faqLimit ? 'inline' : 'none';
        }

        function renderFAQs() {
            const container = document.getElementById('faq-list');
            if (currentFAQs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>No FAQs yet. Click <strong>Add New FAQ</strong> or <strong>Upload FAQs</strong> to get started!</p>
                    </div>`;
                return;
            }

            container.innerHTML = currentFAQs.map((faq, index) => `
                <div class="faq-item">
                    <div class="faq-header">
                        <div class="faq-question">${escapeHtml(faq.question)}</div>
                        <div class="faq-actions">
                            <button class="btn-small btn-edit" onclick="editFAQ(${index})">‚úèÔ∏è Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteFAQ(${index})">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div class="faq-answer">${escapeHtml(faq.answer)}</div>
                    <div class="faq-triggers">
                        ${faq.triggers.map(t => `<span class="trigger-tag">${escapeHtml(t)}</span>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Add New FAQ';
            document.getElementById('faq-form').reset();
            document.getElementById('faq-id').value = '';
            editingIndex = -1;
            document.getElementById('faq-modal').style.display = 'flex';
        }

        function editFAQ(index) {
            const faq = currentFAQs[index];
            document.getElementById('modal-title').textContent = 'Edit FAQ';
            document.getElementById('faq-id').value = faq.id;
            document.getElementById('faq-question').value = faq.question;
            document.getElementById('faq-answer').value = faq.answer;
            document.getElementById('faq-triggers').value = faq.triggers.join(', ');
            editingIndex = index;
            document.getElementById('faq-modal').style.display = 'flex';
        }

        async function deleteFAQ(index) {
            if (!confirm('Are you sure you want to delete this FAQ?')) return;
            const updatedFAQs = currentFAQs.filter((_, i) => i !== index);
            try {
                const response = await fetch('/api/faqs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: CLIENT_ID, faqs: updatedFAQs })
                });
                const data = await response.json();
                if (data.success) {
                    currentFAQs = updatedFAQs;
                    renderFAQs();
                    showSuccess();
                    updateFaqCount();
                } else { showError(); }
            } catch (e) { showError(); }
        }

        function closeModal() {
            document.getElementById('faq-modal').style.display = 'none';
        }

        document.getElementById('faq-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const question = document.getElementById('faq-question').value.trim();
            const answer = document.getElementById('faq-answer').value.trim();
            const triggers = document.getElementById('faq-triggers').value.split(',').map(t => t.trim()).filter(Boolean);

            const newFAQ = {
                id: editingIndex >= 0 ? currentFAQs[editingIndex].id : `faq_${Date.now()}`,
                question, answer, triggers
            };

            const updatedFAQs = editingIndex >= 0
                ? currentFAQs.map((f, i) => i === editingIndex ? newFAQ : f)
                : [...currentFAQs, newFAQ];

            try {
                const response = await fetch('/api/faqs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ client_id: CLIENT_ID, faqs: updatedFAQs })
                });
                const data = await response.json();
                if (data.success) {
                    currentFAQs = updatedFAQs;
                    renderFAQs();
                    closeModal();
                    showSuccess();
                    updateFaqCount();
                } else { showError(data.error); }
            } catch (e) { showError(); }
        });

        function showSuccess(msg) {
            const el = document.getElementById('success-message');
            el.textContent = '‚úÖ ' + (msg || 'Changes saved successfully!');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3500);
        }

        function showError(msg) {
            const el = document.getElementById('error-message');
            el.textContent = '‚ùå ' + (msg || 'Error saving changes. Please try again.');
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3500);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ‚îÄ‚îÄ UPLOAD FUNCTIONS ‚îÄ‚îÄ
        function showUploadModal() {
            document.getElementById('upload-modal').style.display = 'flex';
            resetUploadModal();
        }

        function closeUploadModal() {
            document.getElementById('upload-modal').style.display = 'none';
            resetUploadModal();
        }

        function resetUploadModal() {
            selectedFile = null;
            document.getElementById('faq-file-input').value = '';
            const nameEl = document.getElementById('selected-file-name');
            nameEl.style.display = 'none';
            nameEl.textContent = '';
            document.getElementById('progress-area').style.display = 'none';
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-status').textContent = 'Processing...';
            document.getElementById('progress-status').style.color = '';
            document.getElementById('upload-submit-btn').disabled = true;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { showError('File too large! Maximum size is 10MB.'); return; }
            selectedFile = file;
            const nameEl = document.getElementById('selected-file-name');
            nameEl.textContent = 'üìé ' + file.name;
            nameEl.style.display = 'block';
            document.getElementById('upload-submit-btn').disabled = false;
        }

        async function startUpload() {
            if (!selectedFile) return;
            document.getElementById('progress-area').style.display = 'block';
            document.getElementById('progress-fill').style.width = '30%';
            document.getElementById('progress-status').textContent = 'Uploading file...';
            document.getElementById('upload-submit-btn').disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('client_id', CLIENT_ID);

            try {
                document.getElementById('progress-fill').style.width = '60%';
                document.getElementById('progress-status').textContent = 'Processing FAQs...';
                const response = await fetch('/api/faq/upload', { method: 'POST', body: formData });
                document.getElementById('progress-fill').style.width = '100%';
                const data = await response.json();
                if (data.success) {
                    document.getElementById('progress-status').textContent = '‚úÖ ' + data.message;
                    document.getElementById('progress-status').style.color = '#34d399';
                    setTimeout(() => { closeUploadModal(); loadFAQs(); showSuccess(data.message); }, 1500);
                } else {
                    document.getElementById('progress-status').textContent = '‚ùå ' + data.error;
                    document.getElementById('progress-status').style.color = '#f87171';
                    document.getElementById('upload-submit-btn').disabled = false;
                }
            } catch (e) {
                document.getElementById('progress-status').textContent = '‚ùå Upload failed. Please try again.';
                document.getElementById('progress-status').style.color = '#f87171';
                document.getElementById('upload-submit-btn').disabled = false;
            }
        }

        // Drag & drop
        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) {
                const dt = new DataTransfer();
                dt.items.add(file);
                document.getElementById('faq-file-input').files = dt.files;
                handleFileSelect({ target: { files: [file] } });
            }
        });

        // Close on backdrop click / Escape
        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('faq-modal')) closeModal();
            if (e.target === document.getElementById('upload-modal')) closeUploadModal();
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') { closeModal(); closeUploadModal(); }
        });

        // CSV Template download
        function downloadCSVTemplate() {
            const csv = `question,answer,category
What are your business hours?,"We're open Monday-Friday 9 AM - 6 PM EST. Saturday 10 AM - 4 PM. Closed Sundays.",General
How much does it cost?,"Starter: $15/mo | Agency: $60/mo | Enterprise: $199 lifetime",Pricing
Do you offer refunds?,"Yes! We offer a 7-day money-back guarantee no questions asked.",Policies
Can I get a demo?,"Absolutely! Visit lumvi.net/demo to schedule a live demo.",Sales
How do I get started?,"Simply sign up at lumvi.net and follow the setup wizard.",Getting Started`;
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'faq-template.csv'; a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>